<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>ESP32 Reflow Controller</title>

  <!-- Bootstrap core JavaScript -->
  <script src="src/jquery.min.js"></script>
  <script src="src/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="src/bootstrap.min.css">

  <!-- Custom styles for this template -->
  <link href="src/simple-sidebar.css" type="text/css" rel="stylesheet">

  <script src="https://code.highcharts.com/highcharts.js"></script>

</head>

<body onload="loadDoc()">

  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-right" id="sidebar-wrapper">
      <div class="list-group list-group-flush">
        <a href="#home" class="list-group-item list-group-item-action bg-light">Home</a>
        <a href="#add_profile" class="list-group-item list-group-item-action bg-light">Add profile</a>
        <a href="#change_profile" class="list-group-item list-group-item-action bg-light">Change profile</a>
        <a href="#settings" class="list-group-item list-group-item-action bg-light">Settings</a>
        <a href="#info" class="list-group-item list-group-item-action bg-light">Info</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <button type="button" class="btn btn-primary" id="menu-toggle">
          <span class="glyphicon glyphicon-chevron-right"></span>Hide
        </button>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
          </ul>
        </div>
      </nav>
      <hr />
      <section id="home">
        <div id="chart-temperature" class="chart-container" style="display: none;">
          <!-- <button onclick="hideChart()">Hide chart</button> -->
        </div>
        <div id="chart-profile" class="chart-container" style="display: none;">
          <!-- <button onclick="hideChart()">Hide chart</button> -->
        </div>
        <div id="actualTemp">
          <p>Temperature is: <span id="showTempValue"></span></p>
        </div>
        <div id="profileNameId">
          <p>Used profile: <span id="usedProfileName"></span></p>
        </div>
        <div class="container">
          <h1 class="mt-4">Bootstrap 4 webpage running on ESP32</h1>
          <p>This is simple sidebar webpage running on ESP32 with ESP32 Async webserver library. </p>
        </div>
      </section>
      <hr />
      <section id="add_profile">
        <div class="container-fluid align-items-center">
          <h3 class="section-header">Add profile</h3>
          <div class="form-group mr-2">
            <label class="sr-only" for="inputEmail">Name of the profile</label>
            <input type="number" class="form-control" id="profile_name_new" placeholder="Name of the profile ">
          </div>
          <div class="form-group mr-2">
            <label class="sr-only" for="inputEmail">Alloy</label>
            <input type="number" class="form-control" id="alloy_new" placeholder="Alloy">
          </div>
          <form class="form-inline">
            <div class="form-group mr-2">
              <label class="sr-only" for="inputEmail">Email</label>
              <input type="number" class="form-control" id="preheat_min_new" placeholder="Preheat temp min">
            </div>
            <div class="form-group mr-2">
              <label class="sr-only" for="inputPassword">Password</label>
              <input type="number" class="form-control" id="preheat_max_new" placeholder="Preheat temp max">
            </div>
          </form>
          <form class="form-inline">
            <div class="form-group mr-2">
              <label class="sr-only" for="inputEmail">Email</label>
              <input type="number" class="form-control" id="soak_min_new" placeholder="Soak temp min">
            </div>
            <div class="form-group mr-2">
              <label class="sr-only" for="inputPassword">Password</label>
              <input type="number" class="form-control" id="soak_max_new" placeholder="Soak temp max">
            </div>
          </form>
          <form class="form-inline">
            <div class="form-group mr-2">
              <label class="sr-only" for="inputEmail">Email</label>
              <input type="number" class="form-control" id="reflow_min_new" placeholder="Reflow temp min">
            </div>
            <div class="form-group mr-2">
              <label class="sr-only" for="inputPassword">Password</label>
              <input type="number" class="form-control" id="reflow_max_new" placeholder="Reflow temp max">
            </div>
          </form>
          <form class="form-inline">
            <div class="form-group mr-2">
              <label class="sr-only" for="inputEmail">Email</label>
              <input type="number" class="form-control" id="cool_max_new" placeholder="Cool temp max">
            </div>
            <div class="form-group mr-2">
              <label class="sr-only" for="inputPassword">Password</label>
              <input type="number" class="form-control" id="cool_min_new" placeholder="Cool temp min">
            </div>
          </form>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </section>
      <hr />
      <section id="change_profile">
        <div class="container-fluid align-items-center">
          <h3 class="section-header">Change profile</h3>
          <div class="dropdown">
            <select id="selectProfile" onchange="getSelectedProfileID()">
              <option>Choose a profile</option>
            </select>
          </div>
          <div id="changeProfile"></div>
      </section>
      <hr />
      <section id="settings">
        <h3 class="section-header">Settings</h3>
        <div class="container-fluid">
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="customFile">
            <label class="custom-file-label" for="customFile">Choose file</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="useOTA">
            <label class="custom-control-label" for="useOTA">Use OTA update</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="buzzer">
            <label class="custom-control-label" for="buzzer">Use buzzer</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="useSPIFFS">
            <label class="custom-control-label" for="useSPIFFS">Use SPIFFS storage</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="fan">
            <label class="custom-control-label" for="fan">Use fan</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="buttons">
            <label class="custom-control-label" for="buttons">Turn this ON if you have Menu & Back button</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" onchange="toggleCheckbox(this)" id="horizontal">
            <label class="custom-control-label" for="horizontal">Vertical/Horizontal display</label>
          </div>
          <!--           <div class="custom-control custom-switch mt-2">
            <input type="checkbox" class="custom-control-input" disabled id="customSwitch2">
            <label class="custom-control-label" for="customSwitch2">Disabled switch element</label>
          </div> -->
        </div>
      </section>
      <hr />
      <section id="info">
        <h3 class="section-header">Info</h3>
      </section>
    </div>

    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->



  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function (e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
      var icon = $(this).parent().find(".glyphicon")
      if (icon.hasClass('glyphicon-chevron-right'))
        icon.removeClass('glyphicon-chevron-right').addClass("glyphicon-chevron-left");
      else
        icon.removeClass('glyphicon-chevron-left').addClass("glyphicon-chevron-right");
    });
  </script>

  <script>
    /*     var chartT = new Highcharts.Chart({
          chart: { renderTo: 'chart-temperature' },
          title: { text: 'Thermocouple temperature' },
          series: [{
            showInLegend: false,
            data: []
          }],
          plotOptions: {
            line: {
              animation: false,
              dataLabels: { enabled: true }
            },
            series: { color: '#059e8a' }
          },
          xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
          },
          yAxis: {
            title: { text: 'Temperature (Celsius)' }
            //title: { text: 'Temperature (Fahrenheit)' }
          },
          credits: { enabled: false }
        });
    
        var chartP = new Highcharts.Chart({
          chart: { renderTo: 'chart-temperature' },
          title: { text: 'Profile' },
          series: [{
            showInLegend: false,
            data: []
          }],
          plotOptions: {
            line: {
              animation: false,
              dataLabels: { enabled: true }
            },
            series: { color: '#b3ff00' }
          },
          xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
          },
          yAxis: {
            title: { text: 'Temperature (Celsius)' }
            //title: { text: 'Temperature (Fahrenheit)' }
          },
          credits: { enabled: false }
        }); */
    // https://www.highcharts.com/forum/viewtopic.php?t=39890
    // http://jsfiddle.net/j7bu126o/
    var chartT = new Highcharts.Chart({
      chart: {
        type: 'line',
        renderTo: 'chart-temperature'
      },
      title: {
        text: 'Thermocouple temperature'
      },
/*       subtitle: {
        text: 'Source: WorldClimate.com'
      }, */
      xAxis: {
        //categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
      },
      yAxis: {
        title: {
          text: 'Temperature (°C)'
        }
      },
      plotOptions: {
        line: {
          dataLabels: {
            enabled: true
          },
          enableMouseTracking: false
        }
      },
      series: [{
        name: 'Profile',
        data: [[0, 30],
        [20, 90],
        [30, 100],
        [40, 110],
        [110, 140],
        [120, 150],
        [130, 160],
        [150, 183],
        [200, 230],
        [210, 235],
        [220, 230],
        [240, 183],
        [340, 50]]
      }, {
        name: 'Temperature',
        //data: [3.9, 4.2, 5.7, 8.5, 11.9, 15.2, 17.0, 16.6, 14.2, 10.3, 6.6, 4.8]
        data: []
      }]
    });

    if (!!window.EventSource) {
      var source = new EventSource('/events');
      var chartVar = 0;
      var timerVar;
      var totalSeconds = 0;

      function countTimer() {
        ++totalSeconds;
        /*            var hour = Math.floor(totalSeconds /3600);
                   var minute = Math.floor((totalSeconds - hour*3600)/60);
                   var seconds = totalSeconds - (hour*3600 + minute*60);
                   if(hour < 10)
                     hour = "0"+hour;
                   if(minute < 10)
                     minute = "0"+minute;
                   if(seconds < 10)
                     seconds = "0"+seconds;
                   document.getElementById("timer").innerHTML = hour + ":" + minute + ":" + seconds; */
      }

      source.addEventListener('open', function (e) {
        console.log("Events Connected");
      }, false);
      source.addEventListener('error', function (e) {
        if (e.target.readyState != EventSource.OPEN) {
          console.log("Events Disconnected");
        }
      }, false);

      source.addEventListener('message', function (e) {
        console.log("message", e.data);
      }, false);
      
      source.addEventListener('serialMess', function (e) {
        console.log("serialMess", e.data);
      }, false);

      source.addEventListener('showchart', function (e) {
        chartVar = parseInt(e.data);
        console.log("Oven state change", chartVar);
        var x = document.getElementById("chart-temperature");
        console.log("Display value is:", x);
        if (chartVar != 0) {
          x.style.display = "block";
          timerVar = setInterval(countTimer, 1000);
        } else {
          x.style.display = "none";
          totalSeconds = 0;
          console.log(totalSeconds);
          chartT.series[1].setData([]);
        }
      }, false);

      source.addEventListener('temperature', function (e) {
        var a = document.getElementById("actualTemp");
        if (chartVar != 0) {
          a.style.display = "none";
          console.log("temperature", e.data);
          //var x = (new Date()).getTime(),
          totalSeconds,
            y = parseInt(e.data);
          if (chartT.series[1].data.length > 40) {
            chartT.series[1].addPoint([totalSeconds, y], true, true, true);
          } else {
            chartT.series[1].addPoint([totalSeconds, y], true, false, true);
          }
        } else {
          a.style.display = "block";
          var intTemp = parseInt(e.data);
          document.getElementById("showTempValue").innerHTML = intTemp;
          console.log(intTemp);
        }
      }, false);

      source.addEventListener('usedProfile', function (e) {
        var usedProfile = e.data;
        console.log("ID of used profile", usedProfile);
        //var a = document.getElementById("profileNameId");
        document.getElementById("usedProfileName").innerHTML = usedProfile;
      }, false);

      source.addEventListener('setSettings', function (e) {
        var changeValue = e.data;
        console.log(changeValue);
        toggleCheckboxExternal(changeValue);
        /*         if (changeValue.checked) {
                  document.getElementById(changeValue.id).checked = false;
                } else {
                  document.getElementById(changeValue.id).checked = true;
                } */
      }, false);
    }
  </script>

  <script>
    function loadDoc() {
      var index = ["getSettings", "usedProfile", "profileNames"];
      var request = new XMLHttpRequest();
      (function loop(i, length) {
        if (i >= length) {
          return;
        }
        var url = index[i];
        console.log(url);
        request.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            if (i == 2) {
              console.log(this.responseText);
              var response = this.responseText;
              var ar = response.split(', ');
              var numItemsArray;
              console.log(ar);
              var select = document.getElementById("selectProfile");
              for (var j = 0; j < ar.length - 1; j++) {
                var opt = ar[j];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
              }
            } else if (i == 1) {
              console.log(this.responseText);
              var usedProfile = this.responseText;
              document.getElementById("usedProfileName").innerHTML = usedProfile;
            } else {
              console.log(this.responseText);
              var responseSettings = this.responseText;
              var arrraySettings = responseSettings.split(',');
              console.log(arrraySettings);
              if (arrraySettings[0] == 1) {
                document.getElementById("useOTA").checked = true;
              }
              if (arrraySettings[1] == 1) {
                document.getElementById("buzzer").checked = true;
              }
              if (arrraySettings[2] == 1) {
                document.getElementById("useSPIFFS").checked = true;
              }
              if (arrraySettings[3] == 1) {
                document.getElementById("fan").checked = true;
              }
              if (arrraySettings[4] == 1) {
                document.getElementById("buttons").checked = true;
              }
              if (arrraySettings[5] == 1) {
                document.getElementById("horizontal").checked = true;
              }
            }
            loop(i + 1, length);
          }
        }
        request.open("GET", url);
        request.send();
      })(0, index.length);
    }
  </script>

  <script>
    function getSelectedProfileID() {
      //Getting Value
      var selObj = document.getElementById("selectProfile");
      var selValue = selObj.selectedIndex - 1;
      console.log(selValue);
      //add callback for profile retrieve with parametr of selValue -> call for GFG_DOWN to create right editable form
      getProfileById(selValue);
    }
  </script>

  <script>
    function getProfileById(Id) {
      var xhttp = new XMLHttpRequest();
      var profileArray;
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log(this.responseText);
          var profileResponse = this.responseText;
          profileArray = profileResponse.split(',');
          console.log(profileArray);
          createForm(profileArray);
        }
      };
      xhttp.open("GET", "getProfile?id=" + Id, true);
      xhttp.send();
    }
  </script>

  <script>
    function toggleCheckbox(element) {
      var xhr = new XMLHttpRequest();
      if (element.checked) { xhr.open("GET", "/update?output=" + element.id + "&state=1", true); }
      else { xhr.open("GET", "/update?output=" + element.id + "&state=0", true); }
      console.log(xhr);
      xhr.send();
    }
  </script>

  <script>
    function toggleCheckboxExternal(element) {
      //var xhr = new XMLHttpRequest();

      var split = element.split(',');
      console.log(split);
      if (split[1] == 1) {
        document.getElementById(split[0]).checked = true;
        console.log("Button " + split[0] + " should be OFF");
      }
      else {
        document.getElementById(split[0]).checked = false;
        console.log("Button " + split[0] + " should be ON");
      }
      //console.log(xhr);
      //xhr.send();
    }
  </script>

  <script>
    // Create a break line element 
    //var br = document.createElement("br");
    function createForm(profileArray) {
      //test.remove();
      var variable = document.getElementById("changeProfile");
      while (variable.firstChild) {
        variable.removeChild(variable.firstChild);
      }
      // Create a form synamically 
      var form = document.createElement("form");
      form.setAttribute("method", "post");
      form.setAttribute("action", "");
      variable.appendChild(form);

      // Create an label element for profile name
      var namelabel = document.createElement('label'); // Create Label for Name Field
      namelabel.innerHTML = "Name of the profile:"; // Set Field Labels
      form.appendChild(namelabel);

      // Create an input element for profile name
      var PN = document.createElement("input");
      PN.setAttribute("type", "text");
      PN.setAttribute("name", "profileName");
      PN.setAttribute("value", profileArray[0]);
      form.appendChild(PN);

      // Create an label element for alloy
      var alloylabel = document.createElement('label'); // Create Label for Name Field
      alloylabel.innerHTML = "Alloy:"; // Set Field Labels
      form.appendChild(alloylabel);

      // Create an input element for alloy
      var AL = document.createElement("input");
      AL.setAttribute("type", "text");
      AL.setAttribute("name", "alloy");
      AL.setAttribute("value", profileArray[1]);
      form.appendChild(AL);

      // Create an label element for preheat min temp
      var pmintlabel = document.createElement('label'); // Create Label for Name Field
      pmintlabel.innerHTML = "Preheat min temp:"; // Set Field Labels
      form.appendChild(pmintlabel);

      // Create an input element for preheat minimum temp
      var PMINT = document.createElement("input");
      PMINT.setAttribute("type", "number");
      PMINT.setAttribute("name", "pmint");
      PMINT.setAttribute("value", profileArray[8]);
      form.appendChild(PMINT);

      // Create an label element for preheat max temp
      var pmaxtlabel = document.createElement('label'); // Create Label for Name Field
      pmaxtlabel.innerHTML = "Preheat max temp:"; // Set Field Labels
      form.appendChild(pmaxtlabel);

      // Create an input element for preheat max temp
      var PMAXT = document.createElement("input");
      PMAXT.setAttribute("type", "number");
      PMAXT.setAttribute("name", "pmaxt");
      PMAXT.setAttribute("value", profileArray[2]);
      form.appendChild(PMAXT);


      // Create an label element for soak min temp
      var smintlabel = document.createElement('label'); // Create Label for Name Field
      smintlabel.innerHTML = "Soak min temp:"; // Set Field Labels
      form.appendChild(smintlabel);

      // Create an input element for soak min temp
      var SMINT = document.createElement("input");
      SMINT.setAttribute("type", "number");
      SMINT.setAttribute("name", "smint");
      SMINT.setAttribute("value", profileArray[11]);
      form.appendChild(SMINT);

      // Create an label element for soak max temp
      var smaxtlabel = document.createElement('label'); // Create Label for Name Field
      smaxtlabel.innerHTML = "Soak max temp:"; // Set Field Labels
      form.appendChild(smaxtlabel);

      // Create an input element for soak max temp
      var SMAXT = document.createElement("input");
      SMAXT.setAttribute("type", "number");
      SMAXT.setAttribute("name", "smaxt");
      SMAXT.setAttribute("value", profileArray[4]);
      form.appendChild(SMAXT);

      // Create an label element for reflox min temp
      var rmintlabel = document.createElement('label'); // Create Label for Name Field
      rmintlabel.innerHTML = "Reflow min temp:"; // Set Field Labels
      form.appendChild(rmintlabel);

      // Create an input element for reflow min temp
      var RMINT = document.createElement("input");
      RMINT.setAttribute("type", "number");
      RMINT.setAttribute("name", "rmint");
      RMINT.setAttribute("value", profileArray[13]);
      form.appendChild(RMINT);

      // Create an label element for reflow max temp
      var rmaxtlabel = document.createElement('label'); // Create Label for Name Field
      rmaxtlabel.innerHTML = "Reflow max temp:"; // Set Field Labels
      form.appendChild(rmaxtlabel);

      // Create an input element for reflow max temp
      var RMAXT = document.createElement("input");
      RMAXT.setAttribute("type", "number");
      RMAXT.setAttribute("name", "rmaxt");
      RMAXT.setAttribute("value", profileArray[4]);
      form.appendChild(RMAXT);

      // Create an label element for cool max temp
      var cmaxtlabel = document.createElement('label'); // Create Label for Name Field
      cmaxtlabel.innerHTML = "Cool start temp:"; // Set Field Labels
      form.appendChild(cmaxtlabel);

      // Create an input element for reflow min temp
      var CMAXT = document.createElement("input");
      CMAXT.setAttribute("type", "number");
      CMAXT.setAttribute("name", "cmaxt");
      CMAXT.setAttribute("value", profileArray[15]);
      form.appendChild(CMAXT);

      // Create an label element for cool min temp
      var cmintlabel = document.createElement('label'); // Create Label for Name Field
      cmintlabel.innerHTML = "Cool end temp:"; // Set Field Labels
      form.appendChild(cmintlabel);

      // Create an input element for cool min temp
      var CMINT = document.createElement("input");
      CMINT.setAttribute("type", "number");
      CMINT.setAttribute("name", "cmint");
      CMINT.setAttribute("value", profileArray[8]);
      form.appendChild(CMINT);

      //create a submit button 
      var chb = document.createElement("input");
      chb.setAttribute("type", "submit");
      chb.setAttribute("value", "Change");
      form.appendChild(chb);
    } 
  </script>
</body>

</html>